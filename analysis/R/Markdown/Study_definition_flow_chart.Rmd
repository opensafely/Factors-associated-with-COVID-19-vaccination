<!-- This rmd imports the population flow chart data (`input_flow_chart.csv`) then sequentially drops each of the variables that appears in the population definition logic and counts the remaining population to provide numbers for a flowchart to show inclusion/exclusion of patients in the study. -->
  
---
title: "Study definition flow chart" 
output: 
  html_document
---
  
```{r setup, include=FALSE}
knitr::opts_knit$set(echo = FALSE)
```

```{r, echo = FALSE, warning= FALSE, message= FALSE}
# Preliminaries ----

## Import libraries ----
library(tidyverse)
library(magrittr)
library(Gmisc)
library(glue)
library(crayon)
library(grid)

## Import data ----
data_flow_chart <- read_csv(
  here::here("output", "input_flow_chart.csv"),
  col_types = cols(
    
    # Identifiers
    patient_id = col_integer(),
    
    # Study criteria
    registered = col_logical(),
    has_died = col_logical(),
    age = col_integer(),
    has_follow_up_previous_year = col_logical(),
    nursing_residential_care = col_character(),
    sex = col_character(),
    imd = col_character(),
    region = col_character(),
    stp = col_character(),
    rural_urban = col_integer(),
    practice_id = col_integer(),
    practice_id_at_end = col_integer(),
    practice_id_at_death = col_integer(),
    practice_id_same = col_integer(),
    death_date = col_date(format="%Y-%m-%d")

  ),
  na = character() # more stable to convert to missing later
  ) %>%
  mutate(practice_id_at_end_or_at_death = ifelse(!is.na(death_date) & death_date < as.Date("2021-03-17", format = "%Y-%m-%d"), practice_id_at_death, practice_id_at_end))

```


### Inclusion/exclusion numbers
```{r, echo = FALSE}
data_flow_chart %>%
  filter(practice_id_same == 1) %>%
  nrow()

data_flow_chart %>%
  filter(practice_id == practice_id_at_end_or_at_death) %>%
  nrow()
```
#### Population aged over 80 years, alive and registered with a general practice using TPP software on 7th December 2020
```{r, echo = FALSE}
criteria_1 <- data_flow_chart %>%
  filter(age >= 80,
         registered == TRUE,
         has_died == FALSE)
criteria_1 %>%
  nrow()
```

#### At least 1 year of follow-up prior to 7th December 2020
```{r, echo = FALSE}
criteria_2 <- data_flow_chart %>%
  filter(age >= 80,
         registered == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE) 
```

Excluded = `r nrow(criteria_1) - nrow(criteria_2)`

```{r, echo = FALSE}
criteria_2 %>%
  nrow()
```

#### Non care home
```{r, echo = FALSE}
criteria_3 <- data_flow_chart %>%
  filter(age >= 80,
         registered == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         nursing_residential_care == 0) 
```

Excluded = `r nrow(criteria_2) - nrow(criteria_3)`

```{r, echo = FALSE}
criteria_3 %>%
  nrow()
```

#### Patients with non-missing sex
```{r, echo = FALSE}
criteria_4 <- data_flow_chart %>%
  filter(age >= 80,
         registered == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         nursing_residential_care == 0,
         sex %in% c("F", "M")
         ) 
```

Excluded = `r nrow(criteria_3) - nrow(criteria_4)`

```{r, echo = FALSE}
criteria_4 %>%
  nrow()
```


#### Patients with non-missing IMD
```{r, echo = FALSE}
criteria_5 <- data_flow_chart %>%
  filter(age >= 80,
         registered == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         nursing_residential_care == 0,
         sex %in% c("F", "M"),
         imd > 0) 
```

Excluded = `r nrow(criteria_4) - nrow(criteria_5)`

```{r, echo = FALSE}
criteria_5 %>%
  nrow()
```

#### Patients with non-missing region
```{r, echo = FALSE}
criteria_6 <- data_flow_chart %>%
  filter(age >= 80,
         registered == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         nursing_residential_care == 0,
         sex %in% c("F", "M"),
         imd > 0,
         region != ""
         ) 
```

Excluded = `r nrow(criteria_5) - nrow(criteria_6)`

```{r, echo = FALSE}
criteria_6 %>%
  nrow()
```

#### Patients with non-missing stp
```{r, echo = FALSE}
criteria_7 <- data_flow_chart %>%
  filter(age >= 80,
         registered == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         nursing_residential_care == 0,
         sex %in% c("F", "M"),
         imd > 0,
         region != "",
         stp != "") 
```

Excluded = `r nrow(criteria_6) - nrow(criteria_7)`

```{r, echo = FALSE}
criteria_7 %>%
  nrow()
```

#### Patients with non-missing rural/urban
```{r, echo = FALSE}
criteria_8 <- data_flow_chart %>%
  filter(age >= 80,
         registered == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         nursing_residential_care == 0,
         sex %in% c("F", "M"),
         imd > 0,
         region != "",
         stp != "",
         rural_urban > 0) 
```

Excluded = `r nrow(criteria_7) - nrow(criteria_8)`

```{r, echo = FALSE}
criteria_8 %>%
  nrow()
```

#### Patients with same practice id at start and end of study period
```{r, echo = FALSE}
criteria_9 <- data_flow_chart %>%
  filter(age >= 80,
         registered == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         nursing_residential_care == 0,
         sex %in% c("F", "M"),
         imd > 0,
         region != "",
         stp != "",
         rural_urban > 0,
         practice_id == practice_id_at_end_or_at_death
         ) 
```

Excluded = `r nrow(criteria_8) - nrow(criteria_9)`

```{r, echo = FALSE}
criteria_9 %>%
  nrow()
```

#### Patients in practices with less than 100 "study population" registered patients
```{r, echo = FALSE}
practice_counts <- criteria_9 %>% 
  group_by(practice_id) %>%
  summarise(`Number_of_registered_patients` = n())

criteria_10 <- data_flow_chart %>%
  filter(age >= 80,
         registered == TRUE,
         has_died == FALSE,
         has_follow_up_previous_year == TRUE,
         nursing_residential_care == 0,
         sex %in% c("F", "M"),
         imd > 0,
         region != "",
         stp != "",
         rural_urban > 0,
         practice_id == practice_id_at_end_or_at_death,
         practice_id %in% subset(practice_counts, Number_of_registered_patients >= 100)$practice_id) 
```

Excluded = `r nrow(criteria_8) - nrow(criteria_9)`

```{r, echo = FALSE}
criteria_10 %>%
  nrow()
```

### Inclusion/exclusion chart
``` {r, echo = FALSE, warning= FALSE, message= FALSE, fig.width = 8, fig.height = 10}
# The key boxes that we want to plot

## Population alive and registered with a general practice using TPP software on 7th December 2020
criteria1 <- boxGrob(glue_col("All patients aged 80 years and older \n who were alive and registered with a general \n practice using TPP software \n on 7 December 2020",
                              "N = {pop}",
                              pop = txtInt(nrow(criteria_1)),
                              .sep = "\n"))

## At least 1 year of follow-up prior to 7th December 2020
exclude1 <- boxGrob(glue_col("<1 year of prior follow-up",
                             "n = {pop}",
                             pop = txtInt(nrow(criteria_1) - nrow(criteria_2)),
                             .sep = "\n"),
                    txt_gp = gpar(fontsize = 9))

criteria2 <- boxGrob(glue("At least 1 year of follow-up \n prior to 7 December 2020",
                          "N = {pop}",
                          pop = txtInt(nrow(criteria_2)),
                          .sep = "\n"))

## Non-care home residents
exclude2 <- boxGrob(glue_col("Care home residents",
                             "n = {pop}",
                             pop = txtInt(nrow(criteria_2) - nrow(criteria_3)),
                             .sep = "\n"),
                    txt_gp = gpar(fontsize = 9))

criteria3 <- boxGrob(glue("Non-care home residents",
                          "N = {pop}",
                          pop = txtInt(nrow(criteria_3)),
                          .sep = "\n"))

## Patients with non-missing sex, ethnicity, IMD, region, stp and urban/rural
exclude3 <- boxGrob(glue("Missing data (n = {tot})",
                         " - Sex: {sex}",
                         " - IMD: {imd}",
                         " - Region: {region}",
                         " - STP: {stp}",
                         " - Urban/rural: {urban}",
                         tot = txtInt(nrow(criteria_4) - nrow(criteria_8)),
                         sex = txtInt(nrow(criteria_4 %>% filter(!(sex %in% c("F", "M"))))),
                         imd = txtInt(nrow(criteria_4 %>% filter(imd == 0))),
                         region = txtInt(nrow(criteria_4 %>% filter(region == ""))),
                         stp = txtInt(nrow(criteria_4 %>% filter(stp == ""))),
                         urban = txtInt(nrow(criteria_4 %>% filter(rural_urban > 0))),
                         .sep = "\n"),
                    txt_gp = gpar(fontsize = 9),
                    just = "left")

criteria4 <- boxGrob(glue("Patients with non-missing data",
                          "N = {pop}",
                          pop = txtInt(nrow(criteria_8)),
                          .sep = "\n"))

## Patients with same practice id at start and end of study period
exclude4 <- boxGrob(glue_col("Patients who have moved \n practice during study period",
                             "n = {pop}",
                             pop = txtInt(nrow(criteria_8) - nrow(criteria_9)),
                             .sep = "\n"),
                    txt_gp = gpar(fontsize = 9))

criteria5 <- boxGrob(glue("Patients registered at same practice throughout study period",
                          "N = {pop}",
                          pop = txtInt(nrow(criteria_9)),
                          .sep = "\n"))

## Patients in practices with less than 100 "study population" registered patients
exclude5 <- boxGrob(glue("Patients excluded (n = {tot})",
                         " - Practices excluded: {prac}",
                         tot = txtInt(nrow(criteria_9) - nrow(criteria_10)),
                         prac = txtInt(length(subset(practice_counts, Number_of_registered_patients < 100)$practice_id)),
                         .sep = "\n"),
                    txt_gp = gpar(fontsize = 9),
                    just = "left")

# Final study population
final <- boxGrob(glue("Individuals included in study population",
                      "N = {pop}",
                      pop = txtInt(nrow(criteria_10)),
                      .sep = "\n"))

# Move boxes to where we want them
vert <- spreadVertical(criteria1 = criteria1,
                       criteria2 = criteria2,
                       criteria3 = criteria3,
                       criteria4 = criteria4,
                       criteria5 = criteria5,
                       final = final)

exclude1 <- moveBox(exclude1,
                    x = 0.85,
                    y = coords(vert$criteria2)$top +
                      distance(vert$criteria1, vert$criteria2, half = TRUE, center = FALSE))

exclude2 <- moveBox(exclude2,
                    x = 0.85,
                    y = coords(vert$criteria3)$top +
                      distance(vert$criteria2, vert$criteria3, half = TRUE, center = FALSE))

exclude3 <- moveBox(exclude3,
                    x = 0.85,
                    y = coords(vert$criteria4)$top +
                      distance(vert$criteria3, vert$criteria4, half = TRUE, center = FALSE))

exclude4 <- moveBox(exclude4,
                    x = 0.85,
                    y = coords(vert$criteria5)$top +
                      distance(vert$criteria4, vert$criteria5, half = TRUE, center = FALSE))

exclude5 <- moveBox(exclude5,
                    x = 0.85,
                    y = coords(vert$final)$top +
                      distance(vert$criteria5, vert$final, half = TRUE, center = FALSE))

# Connect vertical arrows, skip last box
for (i in 1:(length(vert) - 1)) {
  connectGrob(vert[[i]], vert[[i + 1]], type = "vert") %>%
    print
}

# Add a connection to the exclusions
connectGrob(vert$criteria1, exclude1, type = "L")
connectGrob(vert$criteria2, exclude2, type = "L")
connectGrob(vert$criteria3, exclude3, type = "L")
connectGrob(vert$criteria4, exclude4, type = "L")
connectGrob(vert$criteria5, exclude5, type = "L")

# Print boxes
vert
exclude1
exclude2
exclude3
exclude4
exclude5
```